<%@ codepage="65001" language="VBScript" %><% option Explicit %><% response.Charset="UTF-8" %><%	Response.AddHeader "Cache-Control","no-cache"	Response.AddHeader "Expires","0"	Response.AddHeader "Pragma","no-cache"%><%'####################################################' Description : 친구하나! 치킨둘 kakao 친구초대' History : 2014.08.11 한용민'####################################################%><!-- #include virtual="/lib/db/dbopen.asp" --><!-- #include virtual="/lib/util/commlib.asp" --><!-- #include virtual="/event/lib/event_etc_function.asp" --><!-- #include virtual="/lib/util/rndSerial.asp" --><!-- #include virtual="/apps/appcom/wish/webview/event/etc/kakao_invite/event54106Cls.asp" --><%dim eCode, userid, mode, sqlstr, refer, tmpidx	eCode=getevt_code	userid = getloginuserid()	mode = requestcheckvar(request("mode"),32)Dim upin, username, userhp, oinvite, tmpusername, tmpval, tmpvalarr, orgusername	upin = requestCheckVar(request("upin"),50)	username = requestcheckvar(request("username"),16)	userhp = requestcheckvar(getNumeric(request("userhp")),16)dim subscriptcount, subscriptcount1, subscriptcount2	subscriptcount=0	subscriptcount1=0	subscriptcount2=0refer = request.ServerVariables("HTTP_REFERER")if InStr(refer,"10x10.co.kr")<1 then	Response.Write "<script type='text/javascript'>alert('잘못된 접속 입니다.'); parent.top.location.href='/apps/appCom/wish/webview/event/eventmain.asp?eventid="&getevt_code&"'</script>"	dbget.close() : Response.Endend ifIf not(getnowdate>="2014-08-13" and getnowdate<"2014-08-21") Then	Response.Write "<script type='text/javascript'>alert('이벤트 응모 기간이 아닙니다.'); parent.top.location.href='/apps/appCom/wish/webview/event/eventmain.asp?eventid="&getevt_code&"'</script>"	dbget.close() : Response.EndEnd IFif mode="invitereg" then	If userid = "" Then		Response.Write "<script type='text/javascript'>alert('로그인을 해주세요'); parent.top.location.href='/apps/appCom/wish/webview/event/eventmain.asp?eventid="&getevt_code&"'</script>"		dbget.close() : Response.End	End IF	set oinvite = new Cevent_etc_common_list		oinvite.frectuserid=userid		oinvite.frectevt_code=eCode		oinvite.frectsub_opt1=getnowdate		If IsUserLoginOK() Then			oinvite.event_subscript_one()		end if				if oinvite.ftotalcount >0 then			subscriptcount=1			tmpval = oinvite.foneitem.fsub_opt3						if tmpval<>"" then				tmpvalarr=split(tmpval,"!@#")								if ubound(tmpvalarr)=1 then					tmpusername=tmpvalarr(0)				end if			end if			if oinvite.FOneItem.fsub_opt2=2 then				subscriptcount2=1			end if		end if	set oinvite=nothing	if subscriptcount2 <> 0 then		Response.Write "<script type='text/javascript'>alert('이미 친구초대가 완료 되었습니다. 내일 다시 도전해 주세요.!'); parent.top.location.href='/apps/appCom/wish/webview/event/eventmain.asp?eventid="&getevt_code&"'</script>"		dbget.close() : Response.End	end if	if subscriptcount > 0 then		Response.Write "<script type='text/javascript'>alert('이미 친구초대를 하셨습니다. 내일 다시 도전해 주세요.!'); parent.top.location.href='/apps/appCom/wish/webview/event/eventmain.asp?eventid="&getevt_code&"'</script>"		dbget.close() : Response.End	end if	sqlstr = "INSERT INTO [db_event].[dbo].[tbl_event_subscript](evt_code, userid, sub_opt1, sub_opt2, sub_opt3, device)" + vbcrlf	sqlstr = sqlstr & " VALUES("& eCode &", '" & userid & "', '"& getnowdate &"', 1, '', 'A')" + vbcrlf	'response.write sqlstr & "<Br>"	dbget.execute sqlstr	sqlstr="select IDENT_CURRENT('[db_event].[dbo].[tbl_event_subscript]') as idx"	'response.write sqlstr & "<Br>"	rsget.Open sqlstr,dbget	IF not rsget.EOF THEN		tmpidx = rsget("idx")	END IF	rsget.close	if tmpidx = "" then		Response.Write "<script type='text/javascript'>alert('정상적인 경로가 아닙니다.'); parent.top.location.href='/apps/appCom/wish/webview/event/eventmain.asp?eventid="&getevt_code&"'</script>"		dbget.close() : Response.End	end if	response.write rdmSerialEnc(tmpidx)elseif mode="winnerreg" then	If userid = "" Then		Response.Write "<script type='text/javascript'>alert('로그인을 해주세요'); parent.top.location.href='/apps/appCom/wish/webview/event/eventmain.asp?eventid="&getevt_code&"'</script>"		dbget.close() : Response.End	End IF	set oinvite = new Cevent_etc_common_list		oinvite.frectuserid=userid		oinvite.frectevt_code=eCode		oinvite.frectsub_opt1=getnowdate		If IsUserLoginOK() Then			oinvite.event_subscript_one()		end if				if oinvite.ftotalcount >0 then			subscriptcount=1			tmpval = oinvite.foneitem.fsub_opt3						if tmpval<>"" then				tmpvalarr=split(tmpval,"!@#")								if ubound(tmpvalarr)=1 then					tmpusername=tmpvalarr(0)				end if			end if			if oinvite.FOneItem.fsub_opt2=2 then				subscriptcount2=1			end if		end if	set oinvite=nothing	if subscriptcount<1 then		Response.Write "<script type='text/javascript'>alert('친구에게 카카오톡 보내기를 해주세요.'); parent.top.location.href='/apps/appCom/wish/webview/event/eventmain.asp?eventid="&getevt_code&"'</script>"		dbget.close() : Response.End	end if	if subscriptcount2=0 then		Response.Write "<script type='text/javascript'>alert('친구가 아직 이벤트 페이지에 방문하지 않았어요.'); parent.top.location.href='/apps/appCom/wish/webview/event/eventmain.asp?eventid="&getevt_code&"'</script>"		dbget.close() : Response.End	end if	Response.Write "<script type='text/javascript'>alert('"& printUserId(tmpusername,2,"*") &" 님이 이벤트를 확인하고, 응모를 완료 했어요.!'); parent.top.location.href='/apps/appCom/wish/webview/event/eventmain.asp?eventid="&getevt_code&"'</script>"	dbget.close() : Response.Endelseif mode="replyreg" then	if upin="" then		Response.Write "<script type='text/javascript'>alert('일련번호가 없습니다'); parent.top.location.href='/apps/appCom/wish/webview/event/eventmain.asp?eventid="&getevt_code&"&upin="&upin&"'</script>"		dbget.close() : Response.End	end if		if username="" then		Response.Write "<script type='text/javascript'>alert('이름을 입력해 주세요.'); parent.top.location.href='/apps/appCom/wish/webview/event/eventmain.asp?eventid="&getevt_code&"&upin="&upin&"'</script>"		dbget.close() : Response.End	end if	If userhp = "" Then		Response.Write "<script type='text/javascript'>alert('휴대폰번호를 입력해 주세요.'); parent.top.location.href='/apps/appCom/wish/webview/event/eventmain.asp?eventid="&getevt_code&"&upin="&upin&"'</script>"		dbget.close() : Response.End	End IF	if checkNotValidHTML(username) or checkNotValidHTML(userhp) then		Response.Write "<script type='text/javascript'>alert('내용에 유효하지 않은 글자가 포함되어 있습니다. 다시 작성 해주세요.'); parent.top.location.href='/apps/appCom/wish/webview/event/eventmain.asp?eventid="&getevt_code&"&upin="&upin&"'</script>"		dbget.close() : Response.End	end if	set oinvite = new Cevent_etc_common_list		oinvite.frectsub_idx=rdmSerialDec(upin)		oinvite.frectevt_code=eCode		oinvite.frectsub_opt1=getnowdate		if upin<>"" then			oinvite.event_subscript_one		end if			if oinvite.ftotalcount >0 then			subscriptcount=1			orgusername = get10x10onlineusername(oinvite.foneitem.fuserid)			if oinvite.FOneItem.fsub_opt2=2 then				subscriptcount2=1			end if		end if	set oinvite=nothing	if cstr(orgusername) = cstr(username) then		Response.Write "<script type='text/javascript'>alert('본인을 초대해서 응모할 수 없어요~ 친구와 참여해주세요~'); parent.top.location.href='/apps/appCom/wish/webview/event/eventmain.asp?eventid="&getevt_code&"&upin="&upin&"'</script>"		dbget.close() : Response.End	end if	if subscriptcount2 <> 0 then		Response.Write "<script type='text/javascript'>alert('이미 친구초대가 완료 되었습니다. 내일 다시 도전해 주세요.!'); parent.top.location.href='/apps/appCom/wish/webview/event/eventmain.asp?eventid="&getevt_code&"&upin="&upin&"'</script>"		dbget.close() : Response.End	end if	if subscriptcount < 1 then		Response.Write "<script type='text/javascript'>alert('친구초대된 내역이 없습니다.'); parent.top.location.href='/apps/appCom/wish/webview/event/eventmain.asp?eventid="&getevt_code&"&upin="&upin&"'</script>"		dbget.close() : Response.End	end if	sqlstr = "update [db_event].[dbo].[tbl_event_subscript]" + vbcrlf	sqlstr = sqlstr & " set sub_opt2=2" + vbcrlf	sqlstr = sqlstr & " ,sub_opt3='"&html2db(trim(username))&"!@#"&html2db(trim(userhp))&"'" + vbcrlf	sqlstr = sqlstr & " where evt_code="& eCode &" and sub_idx="& rdmSerialDec(upin) &""	'response.write sqlstr & "<Br>"	dbget.execute sqlstr		Response.Write "<script type='text/javascript'>alert('응모가 완료 되었습니다.'); parent.top.location.href='/apps/appCom/wish/webview/event/eventmain.asp?eventid="&getevt_code&"&upin="&upin&"'</script>"	dbget.close() : Response.Endelse	Response.Write "<script type='text/javascript'>alert('정상적인 경로가 아닙니다.'); parent.top.location.href='/apps/appCom/wish/webview/event/eventmain.asp?eventid="&getevt_code&"'</script>"	dbget.close() : Response.Endend if%><!-- #include virtual="/lib/db/dbclose.asp" -->